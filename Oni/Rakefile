require 'rake/testtask'
require 'rake/clean'
require 'open3'




# interactive command-line program execution
def run_i(cmd_string)
	stdin, stdout_and_stderr, wait_thr = Open3.popen2e cmd_string
	
	output = nil
	begin
		output = stdout_and_stderr.gets
		puts output
	end while output
	
	stdin.close
	stdout_and_stderr.close
end

def run_task(task)
	Rake::Task[task].invoke
	Rake::Task[task].reenable
	# src: http://stackoverflow.com/questions/577944/how-to-run-rake-tasks-from-within-rake-tasks
end





# generate depend file for gcc dependencies
# sh "gcc -MM *.c > depend"

NAME = 'oni'

# the same as before
Rake::TestTask.new do |t|
	# t.test_files = []
	
	# t.libs << 'test'
	# t.test_files = FileList['test/test*.rb']
end



# make the :test task depend on the shared
# object, so it will be built automatically
# before running the tests

# rule to build the extension: this says
# that the extension should be rebuilt
# after any change to the files in ext

c_library = "lib/#{NAME}/#{NAME}.so"


# TODO: update source file list
source_files = Array.new
# source_files += Dir.glob("ext/#{NAME}/*{.rb,.c}")


# Dir.glob("ext/#{NAME}/cpp/oF_Test/*{.cpp,.h}")
source_files += Dir.glob("ext/#{NAME}/**/*{.cpp,.h}")
source_files += ["ext/#{NAME}/extconf.rb", __FILE__]


# FIXME: can't seem to just run rake again to rebuild. keep having to clobber, and then do a full clean build again.

file c_library => source_files do
	Dir.chdir("ext/#{NAME}") do
		# this does essentially the same thing
		# as what RubyGems does
		run_i "ruby extconf.rb"
		
		
		puts "======= Top level Rakefile"
		
		
		# Run make
		flags = ""
		stdin, stdout_and_stderr, wait_thr = Open3.popen2e "make " + flags
		
		output = nil
		begin
			output = stdout_and_stderr.gets
			puts output
		end while output
		
		stdin.close
		stdout_and_stderr.close
	end
	
	cp "ext/#{NAME}/#{NAME}.so", "lib/#{NAME}"
end




task :test => c_library

task :package => c_library do
	`gem build oni.gemspec`
end


# use 'rake clean' and 'rake clobber' to
# easily delete generated files
CLEAN.include('ext/**/*{.o,.log,.so}')
# CLEAN.include('ext/**/Makefile')
CLOBBER.include('lib/**/*.so')
# CLOBBER.include('lib/**/*.gem') # fix this up. I do want to clobber the gem tho

desc "Run tests"
task :default => [:test, c_library]



task :run do
	# require "/home/ravenskrag/Experiments/RubyCPP/Oni/lib/oni.rb"
	require "/home/ravenskrag/Experiments/RubyCPP/Oni/lib/oni/oni.so"
	
	class Window < Oni::Window
		def initialize
			super()
		end
		
		def setup
			
		end
		
		def update
			
		end
		
		def draw
			
		end
	end
	
	x = Window.new
	x.show
end

task :so_test do
	run_i "nm -C -D /home/ravenskrag/Experiments/RubyCPP/Oni/lib/oni/oni.so"
end

# rebuild literally EVERYTHING. start with building oF core, and work your way up.
task :rebuild_everything => [:rebuild_base, :rebuild_project, c_library] do
	
end

task :rebuild_base do
	of_root = "/home/ravenskrag/Experiments/OpenFrameworks/of_v0.9.3_linux64_release/"
	
	path = "libs/openFrameworksCompiled/project"
	path = File.expand_path(path, of_root)
	Dir.chdir path do
		run_i "make clean" # clean up the core
	end
	
	path = "scripts/linux"
	path = File.expand_path(path, of_root)
	Dir.chdir path do
		run_i "./compileOF.sh -j4" # build the core
		
		# run_i "./cleanAllExamples.sh"
		# run_i "./buildAllExamples.sh"
	end
end

task :rebuild_project do
	# rebuilding the project should rebuild the addons too
	Dir.chdir "ext/oni/cpp/oF_Test" do
		run_i "rake clean"
		run_i "rake build"
	end
end

# namespace :windows do
# 	task :package => :default do
# 		`gem build oni_win_precompiled.gemspec`		
# 	end
	
# 	task :release => Rake::Task['windows:package'] do
		
# 	end
# end
