require 'rake/testtask'
require 'rake/clean'
require 'open3'

# generate depend file for gcc dependencies
# sh "gcc -MM *.c > depend"

NAME = 'oni'

# the same as before
Rake::TestTask.new do |t|
	# t.test_files = []
	
	# t.libs << 'test'

	t.test_files = ["test/test_node_creation.rb"]
end



# interactive command-line program execution
def run_i(cmd_string)
	stdin, stdout_and_stderr, wait_thr = Open3.popen2e cmd_string
	
	output = nil
	begin
		output = stdout_and_stderr.gets
		puts output
	end while output
	
	stdin.close
	stdout_and_stderr.close
end



# make the :test task depend on the shared
# object, so it will be built automatically
# before running the tests

# rule to build the extension: this says
# that the extension should be rebuilt
# after any change to the files in ext

c_library = "lib/#{NAME}/#{NAME}.so"

source_files = Array.new
source_files += Dir.glob("ext/#{NAME}/*{.rb,.c}")
source_files += ["ext/#{NAME}/extconf.rb"]

source_files += Dir.glob("ext/#{NAME}/cpp/cpp_core/*{.cpp,.h}")
source_files += Dir.glob("ext/#{NAME}/cpp/cpp_interface/*{.cpp,.h}")

file c_library => source_files do
	Dir.chdir("ext/#{NAME}") do
		# this does essentially the same thing
		# as what RubyGems does
		ruby "extconf.rb"
		
		# Run make
		flags = ""
		stdin, stdout_and_stderr, wait_thr = Open3.popen2e "make " + flags
		
		output = nil
		begin
			output = stdout_and_stderr.gets
			puts output
		end while output
		
		stdin.close
		stdout_and_stderr.close
	end
	
	cp "ext/#{NAME}/#{NAME}.so", "lib/#{NAME}"
end

task :test => c_library

task :package => c_library do
	`gem build oni.gemspec`
end


# use 'rake clean' and 'rake clobber' to
# easily delete generated files
CLEAN.include('ext/**/*{.o,.log,.so}')
# CLEAN.include('ext/**/Makefile')
CLOBBER.include('lib/**/*.so')

desc "Run tests"
# task :default => [:test, :package]

namespace :windows do
	task :package => :default do
		`gem build oni_win_precompiled.gemspec`		
	end
	
	task :release => Rake::Task['windows:package'] do
		
	end
end






BASEPATH = File.absolute_path(File.dirname(__FILE__))

CORE_BUILD_PATH = File.expand_path("./mySketch", BASEPATH)
LIB_BUILD_PATH  = File.expand_path("./static_lib_creator", BASEPATH)

NUMBER_OF_CORES = 4


task :default => :build

# generate all the .o files using the standard openFrameworks build system
task :build_core do
	Dir.chdir CORE_BUILD_PATH do
		run_i "make -j#{NUMBER_OF_CORES}"
	end
end

task :clean_core do
	Dir.chdir CORE_BUILD_PATH do
		run_i "make clean"
	end
end

# use a modified version of the oF build system to generate a C++ static lib
task :build_library do
	Dir.chdir LIB_BUILD_PATH do
		run_i "make static_lib"
	end
end

task :clean_library do
	Dir.chdir LIB_BUILD_PATH do
		run_i "make clean_static_lib"
	end
end


# TODO: current build system generates a C++ only executable. Delete that.
task :build => [:build_core, :build_library]
task :clean => [:clean_core, :clean_library]


# run just the C++ components
task :run => :build do
	Dir.chdir CORE_BUILD_PATH do
		run_i "make RunRelease"
	end
end
